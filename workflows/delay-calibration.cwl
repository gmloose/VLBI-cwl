class: Workflow
cwlVersion: v1.2
id: delay-calibration
label: VLBI delay calibration
doc: |
    The delay calibration pipeline does the following:
    * [If LINC target solutions are supplied]
      applies LINC solutions to target data and flags
      A-team sources,
    * [If LINC target solutions are supplied]
      concatenates the data in groups of 10, performs
      flagging on the international stations.
    * [If a DDF pipeline SOLSDIR directory is supplied]
      corrects direction-dependent effects for the Dutch stations and
      optionally subtracts the LoTSS model outside a user-specifiable region.
    * creates a MeasurementSet with data phase-shifted
      to a given delay calibrator, calibrated for direction-
      independent effects.

requirements:
  - class: SubworkflowFeatureRequirement
  - class: MultipleInputFeatureRequirement
  - class: StepInputExpressionRequirement
  - class: InlineJavascriptRequirement

inputs:
    - id: msin
      type: Directory[]
      doc: The raw data in a MeasurementSet version 2.0 format.

    - id: solset
      type: File?
      doc: |
        The solution tables generated by the LINC target pipeline
        in an HDF5 format.

    - id: delay_calibrator
      type: File
      doc: A delay calibrator catalogue in CSV format.

    - id: filter_baselines
      type: string?
      default: "*&"
      doc: The default filter constraints for the dp3_prep_target step.

    - id: flag_baselines
      type: string[]?
      default: []
      doc: |
        The baselines to be flagged by DP3.
        Can be a pattern, e.g. [ CS013HBA*&&* ].

    - id: phasesol
      type: string?
      default: TGSSphase
      doc: The name of the target solution table to use from the solset input.

    - id: configfile
      type: File
      doc: Settings for the delay calibration in delay_solve.

    - id: selfcal
      type: Directory
      doc: Path of external calibration scripts.

    - id: h5merger
      type: Directory
      doc: External LOFAR helper scripts for merging h5 files.

    - id: linc
      type: Directory
      doc: |
        The installation directory for the
        LOFAR INitial calibration pipeline.

    - id: reference_stationSB
      type: int?
      default: 104
      doc: |
        Subbands are concatenated in the concatenate-flag
        workflow relative to this station subband.

    - id: number_cores
      type: int?
      default: 12
      doc: |
        Number of cores to use per job for tasks with
        high I/O or memory.

    - id: max_dp3_threads
      type: int?
      default: 5
      doc: The number of threads per DP3 process.

    - id: ddf_solsdir
      type: Directory?
      doc: |
        [Required if subtracting LoTSS] Path to the SOLSDIR directory 
        of the DDF-pipeline run, where most of the calibration solutions
        are stored.

    - id: ddf_rundir
      type: Directory?
      doc: |
        [Required if subtracting LoTSS] Path to the directory of the 
        DDF-pipeline run where files required for the subtract can be found.

    - id: box_size
      type: float?
      default: 2.5
      doc: |
        [Required if subtracting LoTSS] Box size, in degrees, outside of which to subtract
        the LoTSS model from the data.

    - id: subtract_chunk_hours
      type: float?
      default: 0.5
      doc: |
        The range of time to predict the LoTSS model for at once. Lowering this value reduces
        memory footprint at the (possible) cost of increased runtime and vice versa.

    - id: do_subtraction
      type: boolean?
      default: false
      doc: When set to true, the LoTSS model will be subtracted from the DDF corrected data.

    - id: do_auto_delay_selection
      type: boolean?
      default: false
      doc: When true, the best delay calibrator will be searched for based on phasediff scores.

steps:
    - id: setup
      label: setup
      in:
        - id: msin
          source: msin
        - id: solset
          source: solset
          valueFrom: $(self)
        - id: filter_baselines
          source: filter_baselines
        - id: flag_baselines
          source: flag_baselines
        - id: phasesol
          source: phasesol
        - id: number_cores
          source: number_cores
        - id: linc
          source: linc
      out:
        - id: logdir
        - id: msout
        - id: summary_file
      run: ./setup.cwl
      when: $(inputs.solset != null)

    - id: sort-concatenate-flag
      in:
        - id: msin
          source:
           - setup/msout
          pickValue: all_non_null
        - id: firstSB
          source: reference_stationSB
        - id: max_dp3_threads
          source: max_dp3_threads
        - id: linc
          source: linc
      out:
        - id: logdir
        - id: msout
        - id: summary_file
      run: ./concatenate-flag.cwl
      label: sort-concatenate-flag
      when: $(inputs.msin != null)

    - id: process_ddf
      in:
        - id: msin
          source:
            - sort-concatenate-flag/msout
            - msin
          pickValue: first_non_null
          valueFrom: $(self)
        - id: solsdir
          source: ddf_solsdir
          valueFrom: $(self)
        - id: ddf_rundir
          source: ddf_rundir
          valueFrom: $(self)
        - id: box_size
          source: box_size
        - id: ncpu
          source: number_cores
        - id: chunkhours
          source: subtract_chunk_hours
        - id: h5merger
          source: h5merger
        - id: do_subtraction
          source: do_subtraction
      out:
        - id: msout
      run: ./process-ddf.cwl
      when: $(inputs.ddf_rundir != null && inputs.solsdir != null)

    - id: phaseup
      in:
        - id: msin
          source:
            - process_ddf/msout
            - sort-concatenate-flag/msout
            - msin
          linkMerge: merge_nested
          pickValue: first_non_null
          valueFrom: $(self)
        - id: delay_calibrator
          source: delay_calibrator
        - id: configfile
          source: configfile
        - id: selfcal
          source: selfcal
        - id: h5merger
          source: h5merger
        - id: linc
          source: linc
        - id: max_dp3_threads
          source: max_dp3_threads
      out:
        - id: msout
        - id: solutions
        - id: pictures
        - id: logdir
        - id: summary_file
      run: ./phaseup-concat.cwl
      label: phaseup
      when: $(inputs.find_best_delay_cal === false)

    - id: select_best_delay_cal
      in:
        - id: find_best_delay_cal
          source: do_auto_delay_selection
        - id: msin
          source:
            - process_ddf/msout
            - sort-concatenate-flag/msout
            - msin
          linkMerge: merge_nested
          pickValue: first_non_null
        - id: h5merger
          source: h5merger
        - id: selfcal
          source: selfcal
        - id: dd_selection
          valueFrom: $(true)
        - id: do_selfcal
          valueFrom: $(true)
        - id: image_cat
          source: delay_calibrator
        - id: select_best_n
          valueFrom: $(1)
        - id: configfile
          source: configfile
      out:
        - id: msout_concat
        - id: images
        - id: fits_images
        - id: h5parm
      run: ./split-directions.cwl
      label: select_best_delay_cal
      when: $(inputs.find_best_delay_cal)

    - id: store_logs
      in:
        - id: files
          linkMerge: merge_flattened
          source:
            - setup/logdir
            - sort-concatenate-flag/logdir
            - phaseup/logdir
          pickValue: all_non_null
        - id: sub_directory_name
          default: logs
      out:
        - id: dir
      run: ../steps/collectfiles.cwl
      label: store_logs
      when: $(inputs.files.length > 0)

    # Selection of the concatenated MSs, as pickValue doesn't allow
    # us to do this in the msouts output of the workflow. The reasoning
    # is the following:
    # If process_ddf was run, take that output.
    # If process_ddf was not run but sort-concatenate-flag was, take that instead.
    # Otherwise, don't collect anything.
    - id: select_concatenated_mss
      in:
        - id: input1
          source: select_best_delay_cal/msout_concat
        - id: input2
          source: sort-concatenate-flag/msout
        - id: input3
          source: process_ddf/msout
      out:
        - id: output
      when: $(inputs.input1 != null || inputs.input2 != null || inputs.input3 != null)
      run: ../utils/select_input.cwl

outputs:
  - id: msout
    outputSource: phaseup/msout
    type: Directory[]
    doc: |
        The fully concatenated data in MeasurementSet
        format, phase-shifted to the delay calibrator.

  - id: msouts
    outputSource:
      - select_concatenated_mss/output
    pickValue: all_non_null
    type: Directory[]?
    doc: |
        The concatenated data in MeasurementSet format after
        A-team clipping and optional DDF solutions applied.

  - id: logs
    outputSource: store_logs/dir
    type: Directory
    doc: |
        The logfiles generated by the pipeline steps,
        sorted per subworkflow.

  - id: solutions
    outputSource:
      - select_best_delay_cal/h5parm
      - phaseup/solutions
    pickValue: first_non_null
    linkMerge: merge_flattened
    type: File
    doc: |
        The calibrated data solutions generated by lofar_facet_selfcal
        in HDF5 format.

  - id: summary_files
    outputSource:
      - setup/summary_file
      - sort-concatenate-flag/summary_file
      - phaseup/summary_file
    pickValue: all_non_null
    type: File[]
    doc: Pipeline summary statistics in JSON format.
