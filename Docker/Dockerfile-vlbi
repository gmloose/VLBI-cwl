FROM lofareosc/prefactor3-cwl

RUN groupadd -r lofaruser && \
    useradd -r -l -m -g lofaruser lofaruser


RUN apt-get update && \
    apt-get install -y \
    python3-regex
RUN python3 -m pip install -Iv pyvo bdsf
#==0.9.3

RUN apt-get update && \
    apt-get install -y \
        git \
        cmake \
        python3-scipy \
        python3-statsmodels \
        python3-astroquery \
        python3-magic && \
    mkdir -p /src

WORKDIR /src

# for stationresponse from the LOFARBeam module;
# adapted from https://github.com/tikk3r/lofar-grid-hpccloud/blob/fedora/Singularity
ARG LOFAR_VERSION=master
RUN git clone --depth 1 --branch ${LOFAR_VERSION} \
        https://github.com/lofar-astron/LOFARBeam.git && \
    mkdir LOFARBeam/build && \
    cd LOFARBeam/build && \
    cmake .. -DBUILD_WITH_PYTHON=ON -DPORTABLE=TRUE && \
    #-DCMAKE_INSTALL_PREFIX=$INSTALLDIR/lofar ../src && \
    make install -j `nproc` && \
    touch /opt/lib/python3/site-packages/lofar/__init__.py && \
    cd /src && \
    rm -rf /src/LOFARBeam/build && \
    rm -rf /src/LOFARBeam/src

WORKDIR /home/lofaruser

USER lofaruser
#RUN git clone https://github.com/lonbar/VLBI-cwl.git /home/lofaruser/VLBI-cwl

ENV PYTHONPATH=/home/lofaruser/VLBI-cwl/scripts/:$PYTHONPATH \
    PATH=/home/lofaruser/VLBI-cwl/scripts:$PATH

# Install VLBI CWL
COPY . /home/lofaruser/VLBI-cwl
